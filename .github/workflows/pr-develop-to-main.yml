# develop/* -> main のPR管理
# このワークフローは develop/* ブランチから main ブランチへのPRに対してのみ実行されます
# - PRオープン時のコメント投稿
# - GitHub Projectsへの自動追加
# - リリース管理用ラベルの自動付与
# - マイルストーンの自動設定
# - Draft変換時の通知

name: PR / develop → main

on:
  pull_request:
    types: [opened, reopened, ready_for_review, converted_to_draft, synchronize, labeled, review_requested]
    branches:
      - main
  pull_request_review:
    types: [submitted]

env:
  # マイルストーン定義
  MILESTONE_VERIFICATION: 1  # 動作確認マイルストーン: https://github.com/Himenon/michibiki/milestone/1
  MILESTONE_IN_DEVELOPMENT: 2  # 開発中マイルストーン: https://github.com/Himenon/michibiki/milestone/2
  MILESTONE_NEXT_RELEASE: 3  # 次回リリースマイルストーン: https://github.com/Himenon/michibiki/milestone/3
  
  # GitHub Project Field ID定義 (https://github.com/users/Himenon/projects/2)
  PROJECT_URL: https://github.com/users/Himenon/projects/2
  PROJECT_ID: PVT_kwHOAGZ3Xc4BLIWA
  PROJECT_FIELD_ID: PVTSSF_lAHOAGZ3Xc4BLIWAzg6y8i0
  PROJECT_STATUS_TODO: f75ad846  # Todo
  PROJECT_STATUS_IN_PROGRESS: 47fc9ee4  # In Progress
  PROJECT_STATUS_TEST: caeb4054  # Test
  PROJECT_STATUS_DONE: 98236657  # Done
  
  # ラベル定義
  LABEL_IN_DEVELOPMENT: 開発中
  LABEL_BEFORE_RELEASE: リリース前
  LABEL_STAGING_RELEASE: Stagingリリース
  LABEL_STAGING_VERIFICATION: Staging確認中
  LABEL_COMPLETED: completed

concurrency:
  group: pr-develop-to-main-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # develop/* ブランチからのPRのみ処理対象
  # PRオープン時に自動コメントを投稿
  pr-open-comment:
    name: PRオープン時のコメント投稿
    if: startsWith(github.event.pull_request.head.ref, 'develop/') && (github.event.action == 'opened' || github.event.action == 'ready_for_review') && github.event.pull_request.draft == false
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
    
    steps:
      - name: PRにコメントを投稺
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}
          BODY: |
            PRをオープンしていただきありがとうございます!
            セルフレビューをしておきましょう。
            <!-- opened-pr-comment -->
        run: |
          # 既存のコメントを検索（マーカーで識別）
          COMMENT_ID=$(gh api repos/$GH_REPO/issues/$NUMBER/comments \
            --jq '.[] | select(.body | contains("<!-- opened-pr-comment -->")) | .id' \
            2>/dev/null | head -n 1)
          
          if [ -n "$COMMENT_ID" ]; then
            # 既存のコメントを更新
            gh api repos/$GH_REPO/issues/comments/$COMMENT_ID -X PATCH -f body="$BODY" > /dev/null 2>&1
            echo "既存のコメント #$COMMENT_ID を更新しました"
          else
            # 新規コメントを作成
            gh pr comment "$NUMBER" --body "$BODY" 2>/dev/null
            echo "新規コメントを作成しました"
          fi

  # GitHub Projectsへの自動追加
  # develop/* -> main のPRを自動的にプロジェクトボードに追加し、ステータスを「In Progress」に設定
  github-project-addition:
    name: GitHub Projectsへの追加
    if: startsWith(github.event.pull_request.head.ref, 'develop/') && (github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'ready_for_review')
    runs-on: ubuntu-slim
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1.12.0
        id: create-github-app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: PRをプロジェクトに追加
        uses: actions/add-to-project@244f685bbc3b7adfa8466e08b698b5577571133e # v1.0.2
        id: add-to-project
        with:
          project-url: ${{ env.PROJECT_URL }}
          github-token: ${{ secrets.GH_PROJECT_TOKEN }}

      - name: ステータスを「In Progress」に設定
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}
          ITEM_ID: ${{ steps.add-to-project.outputs.itemId }}
        run: |
          gh project item-edit --id $ITEM_ID --field-id ${{ env.PROJECT_FIELD_ID }} --project-id ${{ env.PROJECT_ID }} --single-select-option-id ${{ env.PROJECT_STATUS_IN_PROGRESS }} > /dev/null 2>&1

  # リリース管理用ラベルの自動付与
  # Draft状態: 「開発中」ラベル / Ready for review: 「リリース前」ラベル
  release-label-management:
    name: リリース管理ラベルの設定
    if: startsWith(github.event.pull_request.head.ref, 'develop/')
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
    
    steps:
      - name: Ready for review時に「リリース前」ラベル追加と「開発中」ラベル削除
        if: github.event.pull_request.draft == false
        run: |
          gh pr edit "$NUMBER" --add-label "${{ env.LABEL_BEFORE_RELEASE }}" 2>/dev/null
          gh pr edit "$NUMBER" --remove-label "${{ env.LABEL_IN_DEVELOPMENT }}" 2>/dev/null || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}
      
      - name: Draft時に「開発中」ラベル追加と「リリース前」ラベル削除
        if: github.event.pull_request.draft == true
        run: |
          gh pr edit "$NUMBER" --add-label "${{ env.LABEL_IN_DEVELOPMENT }}" 2>/dev/null
          gh pr edit "$NUMBER" --remove-label "${{ env.LABEL_BEFORE_RELEASE }}" 2>/dev/null || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}

  # マイルストーンの自動設定
  # Draft状態: マイルストーン2 / Ready for review: マイルストーン3
  milestone-management:
    name: マイルストーンの設定
    if: startsWith(github.event.pull_request.head.ref, 'develop/') && (github.event.action == 'opened' || github.event.action == 'reopened' || github.event.action == 'ready_for_review' || github.event.action == 'converted_to_draft')
    runs-on: ubuntu-slim
    permissions:
      contents: read
      pull-requests: write
      issues: write
      
    steps:
      - name: Draft状態に応じてマイルストーンを設定
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          IS_DRAFT: ${{ github.event.pull_request.draft }}
        run: |
          if [ "$IS_DRAFT" = "true" ]; then
            MILESTONE_NUMBER=${{ env.MILESTONE_IN_DEVELOPMENT }}
            echo "マイルストーン${MILESTONE_NUMBER}を設定中 (Draft)"
          else
            MILESTONE_NUMBER=${{ env.MILESTONE_NEXT_RELEASE }}
            echo "マイルストーン${MILESTONE_NUMBER}を設定中 (Open)"
          fi
          
          if gh api repos/$REPO/issues/$PR_NUMBER -X PATCH -f milestone=$MILESTONE_NUMBER > /dev/null 2>&1; then
            echo "✓ マイルストーン $MILESTONE_NUMBER をPR #$PR_NUMBER に追加しました"
          else
            echo "✗ PR #$PR_NUMBER へのマイルストーン追加に失敗しました"
            exit 1
          fi

  # Draft変換時の通知コメント
  # PRがDraftに変換されたときに自動的にコメントを投稿
  draft-conversion-notification:
    name: Draft変換時の通知
    if: startsWith(github.event.pull_request.head.ref, 'develop/') && github.event.action == 'converted_to_draft'
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
    
    steps:
      - name: Draft変換時にコメントを投稺
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}
          BODY: |
            このPRはドラフトに変更されました。
            <!-- draft-comment -->
        run: |
          # 既存のコメントを検索（マーカーで識別）
          COMMENT_ID=$(gh api repos/$GH_REPO/issues/$NUMBER/comments \
            --jq '.[] | select(.body | contains("<!-- draft-comment -->")) | .id' \
            2>/dev/null | head -n 1)
          
          if [ -n "$COMMENT_ID" ]; then
            # 既存のコメントを更新
            gh api repos/$GH_REPO/issues/comments/$COMMENT_ID -X PATCH -f body="$BODY" > /dev/null 2>&1
            echo "既存のコメント #$COMMENT_ID を更新しました"
          else
            # 新規コメントを作成
            gh pr comment "$NUMBER" --body "$BODY" 2>/dev/null
            echo "新規コメントを作成しました"
          fi

  # Staging確認中ラベル付与時のマイルストーン変更
  # 「Staging確認中」ラベルが付与されたときにマイルストーン1に変更
  milestone-on-staging-label:
    name: Staging確認中ラベル付与時のマイルストーン設定
    if: startsWith(github.event.pull_request.head.ref, 'develop/') && github.event.action == 'labeled' && github.event.label.name == 'Staging確認中'
    runs-on: ubuntu-slim
    permissions:
      contents: read
      pull-requests: write
      issues: write
      
    steps:
      - name: マイルストーンを1に設定
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          MILESTONE_NUMBER=${{ env.MILESTONE_VERIFICATION }}
          echo "マイルストーン${MILESTONE_NUMBER}を設定中 (Staging確認中)"
          
          if gh api repos/$REPO/issues/$PR_NUMBER -X PATCH -f milestone=$MILESTONE_NUMBER > /dev/null 2>&1; then
            echo "✓ マイルストーン $MILESTONE_NUMBER をPR #$PR_NUMBER に追加しました"
          else
            echo "✗ PR #$PR_NUMBER へのマイルストーン追加に失敗しました"
            exit 1
          fi

  # レビュー再要求時に承認通知コメントを削除
  approved-comment-deletion-on-rerequest:
    name: レビュー再要求時に承認コメント削除
    if: |
      github.event_name == 'pull_request' &&
      github.event.action == 'review_requested' &&
      startsWith(github.event.pull_request.head.ref, 'develop/')
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
      
    steps:
      - name: 承認通知コメントを削除
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          COMMENT_MARKER: "<!-- all-approved-notification -->"
        run: |
          # 承認通知コメントを検索して削除
          COMMENTS=$(gh api repos/$REPO/issues/$PR_NUMBER/comments --jq ".[] | select(.user.login == \"github-actions[bot]\" and (.body | contains(\"$COMMENT_MARKER\"))) | .id" 2>/dev/null)
          
          if [ -n "$COMMENTS" ]; then
            echo "$COMMENTS" | while read -r COMMENT_ID; do
              echo "コメント削除中: $COMMENT_ID"
              gh api -X DELETE repos/$REPO/issues/comments/$COMMENT_ID > /dev/null 2>&1
            done
            echo "レビュー再要求により承認通知コメントを削除しました"
          else
            echo "削除する承認通知コメントはありません"
          fi

  # 全Approve後の通知コメント
  all-approved-notification:
    name: 全Approve後の通知コメント
    if: |
      github.event_name == 'pull_request_review' &&
      github.event.review.state == 'approved' &&
      startsWith(github.event.pull_request.head.ref, 'develop/')
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
      
    steps:
      - name: 全レビューが承認されたか確認
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          LAST_REVIEWER: ${{ github.event.review.user.login }}
          COMMENT_MARKER: "<!-- all-approved-notification -->"
          MESSAGE: |
            全てのレビューが承認されました。
            mainへの変更は責任者によるマージが必要です。責任者によるマージをお待ちください。
        run: |
          # レビュー状態を取得
          REVIEWS=$(gh api repos/$REPO/pulls/$PR_NUMBER/reviews --jq 'group_by(.user.login) | map({user: .[0].user.login, state: .[-1].state})' 2>/dev/null)
          
          # すべてのレビューがAPPROVEDか確認
          PENDING_REVIEWS=$(echo "$REVIEWS" | jq '[.[] | select(.state != "APPROVED")] | length')
          
          # 以前のボットコメントを検索して削除
          COMMENTS=$(gh api repos/$REPO/issues/$PR_NUMBER/comments --jq ".[] | select(.user.login == \"github-actions[bot]\" and (.body | contains(\"$COMMENT_MARKER\"))) | .id" 2>/dev/null)
          
          if [ -n "$COMMENTS" ]; then
            echo "$COMMENTS" | while read -r COMMENT_ID; do
              echo "コメント削除中: $COMMENT_ID"
              gh api -X DELETE repos/$REPO/issues/comments/$COMMENT_ID > /dev/null 2>&1
            done
          fi
          
          # すべて承認されている場合のみ新しいコメントを投稿
          if [ "$PENDING_REVIEWS" -eq 0 ]; then
            gh pr comment $PR_NUMBER --repo $REPO --body "${COMMENT_MARKER}
          @${LAST_REVIEWER} ${MESSAGE}" 2>/dev/null
          fi
