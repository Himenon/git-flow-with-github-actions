name: チェック / PRタイトルプレフィックス

on:
  pull_request:
    types: [opened, edited]
    branches:
      - main
      - release/staging
      - 'develop/**'

concurrency:
  group: pr-title-check-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  pr-title-checking:
    name: PRタイトルプレフィックスのチェック
    runs-on: ubuntu-slim
    if: |
      github.event.pull_request.state == 'open' &&
      (github.event.action == 'opened' || github.event.changes.title != null)
    permissions:
      pull-requests: write
    
    env:
      COMMENT_MARKER: "<!-- pr-title-check-comment -->"
    
    steps:
      - name: PRタイトルプレフィックスをチェック
        id: check
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          VALID_PREFIXES="feat|chore|docs|fix|style|perf|test|refactor"
          
          if echo "$TITLE" | grep -qE "^($VALID_PREFIXES):"; then
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
          fi
      
      - name: 無効な場合はPRにコメント
        if: steps.check.outputs.valid == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}
          BODY: |
            ⚠️ **PR Titleに適切なprefixが付与されていません**
            
            以下のいずれかのprefixを追加してください：
            - `feat:` - 新機能
            - `fix:` - バグ修正
            - `docs:` - ドキュメント変更
            - `style:` - コードスタイル変更（機能に影響しない）
            - `refactor:` - リファクタリング
            - `perf:` - パフォーマンス改善
            - `test:` - テスト追加・修正
            - `chore:` - ビルドプロセスやツールの変更
            
            例: `feat: ユーザー認証機能を追加`
        run: |
          # コメント本文にマーカーを結合
          BODY="${BODY}"$'\n'"${COMMENT_MARKER}"
          
          # 既存のコメントを検索（マーカーで識別）
          COMMENT_ID=$(gh api repos/$GH_REPO/issues/$NUMBER/comments \
            --jq ".[] | select(.body | contains(\"$COMMENT_MARKER\")) | .id" \
            2>/dev/null | head -n 1)
          
          if [ -n "$COMMENT_ID" ]; then
            # 既存のコメントを更新
            gh api repos/$GH_REPO/issues/comments/$COMMENT_ID -X PATCH -f body="$BODY" > /dev/null 2>&1
            echo "既存のコメント #$COMMENT_ID を更新しました"
          else
            # 新規コメントを作成
            gh pr comment "$NUMBER" --body "$BODY" 2>/dev/null
            echo "新規コメントを作成しました"
          fi
      
      - name: 有効な場合はコメントを削除
        if: steps.check.outputs.valid == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # 既存のコメントを検索（マーカーで識別）
          COMMENT_ID=$(gh api repos/$GH_REPO/issues/$NUMBER/comments \
            --jq ".[] | select(.body | contains(\"$COMMENT_MARKER\")) | .id" \
            2>/dev/null | head -n 1)
          
          if [ -n "$COMMENT_ID" ]; then
            # コメントを削除
            gh api repos/$GH_REPO/issues/comments/$COMMENT_ID -X DELETE > /dev/null 2>&1
            echo "コメント #$COMMENT_ID を削除しました"
          else
            echo "削除するコメントはありません"
          fi
      
      - name: 無効な場合は失敗
        if: steps.check.outputs.valid == 'false'
        run: |
          echo "PRタイトルに有効なプレフィックスがありません"
          exit 1
