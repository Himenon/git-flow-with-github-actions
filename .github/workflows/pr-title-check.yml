name: Check / PR Title Prefix

on:
  pull_request:
    types: [opened, edited]
    branches:
      - main
      - release/staging
      - 'develop/**'

concurrency:
  group: pr-title-check-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  check-pr-title:
    runs-on: ubuntu-slim
    if: github.event.action == 'opened' || github.event.changes.title != null
    permissions:
      pull-requests: write
    
    steps:
      - name: Check PR title prefix
        id: check
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          VALID_PREFIXES="feat|chore|docs|fix|style|perf|test|refactor"
          
          if echo "$TITLE" | grep -qE "^($VALID_PREFIXES):"; then
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "valid=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment on PR if invalid
        if: steps.check.outputs.valid == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}
          BODY: |
            ⚠️ **PR Titleに適切なprefixが付与されていません**
            
            以下のいずれかのprefixを追加してください：
            - `feat:` - 新機能
            - `fix:` - バグ修正
            - `docs:` - ドキュメント変更
            - `style:` - コードスタイル変更（機能に影響しない）
            - `refactor:` - リファクタリング
            - `perf:` - パフォーマンス改善
            - `test:` - テスト追加・修正
            - `chore:` - ビルドプロセスやツールの変更
            
            例: `feat: ユーザー認証機能を追加`
            <!-- pr-title-check-comment -->
        run: |
          # 既存のコメントを検索（マーカーで識別）
          COMMENT_ID=$(gh api repos/$GH_REPO/issues/$NUMBER/comments \
            --jq '.[] | select(.body | contains("<!-- pr-title-check-comment -->")) | .id' \
            | head -n 1)
          
          if [ -n "$COMMENT_ID" ]; then
            # 既存のコメントを更新
            gh api repos/$GH_REPO/issues/comments/$COMMENT_ID -X PATCH -f body="$BODY"
            echo "Updated existing comment #$COMMENT_ID"
          else
            # 新規コメントを作成
            gh pr comment "$NUMBER" --body "$BODY"
            echo "Created new comment"
          fi
      
      - name: Delete comment if valid
        if: steps.check.outputs.valid == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # 既存のコメントを検索（マーカーで識別）
          COMMENT_ID=$(gh api repos/$GH_REPO/issues/$NUMBER/comments \
            --jq '.[] | select(.body | contains("<!-- pr-title-check-comment -->")) | .id' \
            | head -n 1)
          
          if [ -n "$COMMENT_ID" ]; then
            # コメントを削除
            gh api repos/$GH_REPO/issues/comments/$COMMENT_ID -X DELETE
            echo "Deleted comment #$COMMENT_ID"
          else
            echo "No comment to delete"
          fi
      
      - name: Fail if invalid
        if: steps.check.outputs.valid == 'false'
        run: |
          echo "PR title does not have a valid prefix"
          exit 1
