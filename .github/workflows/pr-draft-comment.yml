name: Comment / PR Converted to Draft

on:
  pull_request:
    types: [converted_to_draft]

jobs:
  comment:
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
    
    steps:
      - name: Comment on PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}
          BODY: >
            このPRはドラフトに変更されました。
            <!-- draft-comment -->
        run: |
          # 既存のコメントを検索（マーカーで識別）
          COMMENT_ID=$(gh api repos/$GH_REPO/issues/$NUMBER/comments \
            --jq '.[] | select(.body | contains("<!-- draft-comment -->")) | .id' \
            | head -n 1)
          
          if [ -n "$COMMENT_ID" ]; then
            # 既存のコメントを更新
            gh api repos/$GH_REPO/issues/comments/$COMMENT_ID -X PATCH -f body="$BODY"
            echo "Updated existing comment #$COMMENT_ID"
          else
            # 新規コメントを作成
            gh pr comment "$NUMBER" --body "$BODY"
            echo "Created new comment"
          fi

      # - name: Set status to Todo
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GH_PROJECT_TOKEN }}
      #     PROJECT_NUMBER: 2
      #     PROJECT_ID: PVT_kwHOAGZ3Xc4BLIWA
      #     PR_URL: ${{ github.event.pull_request.html_url }}
      #     FIELD_ID: PVTSSF_lAHOAGZ3Xc4BLIWAzg6y8i0
      #     OPTION_ID: f75ad846
      #   run: |
      #     ITEM_ID=$(gh project item-list $PROJECT_NUMBER --owner ${{ github.repository_owner }} --format json --jq ".items[] | select(.content.url == \"$PR_URL\") | .id")
      #     if [ -n "$ITEM_ID" ]; then
      #       gh project item-edit --id $ITEM_ID --field-id $FIELD_ID --project-id $PROJECT_ID --single-select-option-id $OPTION_ID
      #     fi
