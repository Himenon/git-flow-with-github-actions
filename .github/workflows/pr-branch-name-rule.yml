# PRのブランチ名ルール管理
# 許可されるPRのパターン:
# - develop/* -> main, release/staging
# - feature/* -> develop/*
# - hotfix/* -> main, release/staging
# それ以外のパターンは警告を出す

name: PR / ブランチ名ルール

on:
  pull_request:
    types: [opened, edited]

concurrency:
  group: pr-branch-name-rule-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  branch-name-rule-checking:
    name: ブランチ名ルールのチェック
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
    
    env:
      COMMENT_MARKER: "<!-- branch-name-rule-warning -->"
    
    steps:
      - name: ブランチの組み合わせをチェック
        id: check
        env:
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          echo "チェック中: $HEAD_REF -> $BASE_REF"
          VALID=false
          
          # HEADブランチのパターンをチェックし、許可されたBASEブランチへのマージか判定
          case "$HEAD_REF" in
            develop/*) [[ "$BASE_REF" == "main" || "$BASE_REF" == "release/staging" ]] && VALID=true ;;
            feature/*) [[ "$BASE_REF" == develop/* ]] && VALID=true ;;
            hotfix/*)  [[ "$BASE_REF" == "main" || "$BASE_REF" == "release/staging" ]] && VALID=true ;;
          esac
          
          if [ "$VALID" = true ]; then
            echo "✓ 有効: $HEAD_REF -> $BASE_REF"
            echo "valid=true" >> $GITHUB_OUTPUT
          else
            echo "✗ 無効なブランチの組み合わせ"
            echo "valid=false" >> $GITHUB_OUTPUT
          fi
      
      - name: 警告コメントを削除（ルールが正しい場合）
        if: steps.check.outputs.valid == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # 既存の警告コメントがあれば削除
          COMMENT_ID=$(gh api repos/$GH_REPO/issues/$NUMBER/comments \
            --jq ".[] | select(.body | contains(\"$COMMENT_MARKER\")) | .id" \
            2>/dev/null | head -n 1)
          
          if [ -n "$COMMENT_ID" ]; then
            gh api repos/$GH_REPO/issues/comments/$COMMENT_ID -X DELETE > /dev/null 2>&1
            echo "警告コメント #$COMMENT_ID を削除しました"
          else
            echo "削除する警告コメントは見つかりませんでした"
          fi
      
      - name: 警告コメントを投稿（ルール違反の場合）
        if: steps.check.outputs.valid == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}
          HEAD_REF: ${{ github.event.pull_request.head.ref }}
          BASE_REF: ${{ github.event.pull_request.base.ref }}
          BODY: |
            > [!WARNING]
            > ⚠️ **ブランチ名ルール違反**
            > 
            > このPRのブランチの組み合わせは許可されていません。
            
            **現在の設定:**
            - Head: `${{ github.event.pull_request.head.ref }}`
            - Base: `${{ github.event.pull_request.base.ref }}`
            
            **許可されるパターン:**
            - `develop/*` → `main` または `release/staging`
            - `feature/*` → `develop/*`
            - `hotfix/*` → `main` または `release/staging`
            
            **推奨される対応:**
            1. このPRを閉じる
            2. 適切なブランチに向けて新しいPRを作成する
            
            または、GitHub上でBase branchを変更することもできます。
        run: |
          echo "警告コメントを投稿中"
          
          # コメント本文にマーカーを結合
          BODY="${BODY}"$'\n'"${COMMENT_MARKER}"
          
          # 既存のコメントを検索（マーカーで識別）
          COMMENT_ID=$(gh api repos/$GH_REPO/issues/$NUMBER/comments \
            --jq ".[] | select(.body | contains(\"$COMMENT_MARKER\")) | .id" \
            2>/dev/null | head -n 1)
          
          if [ -n "$COMMENT_ID" ]; then
            # 既存のコメントを更新
            gh api repos/$GH_REPO/issues/comments/$COMMENT_ID -X PATCH -f body="$BODY" > /dev/null 2>&1
            echo "既存の警告コメント #$COMMENT_ID を更新しました"
          else
            # 新規コメントを作成
            gh pr comment "$NUMBER" --body "$BODY" 2>/dev/null
            echo "新規警告コメントを作成しました"
          fi
