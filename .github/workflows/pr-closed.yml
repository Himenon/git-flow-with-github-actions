name: クローズ後の処理

on:
  pull_request:
    types: [closed]

concurrency:
  group: pr-closed-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  cleanup-on-close:
    name: クローズ時のクリーンアップ
    if: github.event.pull_request.merged == false
    runs-on: ubuntu-slim
    permissions:
      contents: read
      pull-requests: write
      issues: write
      
    steps:
      - name: ラベルの削除
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          # すべてのラベルを取得して削除
          LABELS=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json labels | jq -r '.labels[].name' | tr '\n' ',' | sed 's/,$//')
          if [ -n "$LABELS" ]; then
            echo "Removing labels: $LABELS"
            gh pr edit "$PR_NUMBER" --repo "$REPO" --remove-label "$LABELS"
            echo "✓ Labels removed"
          else
            echo "No labels to remove"
          fi
      
      - name: マイルストーンの削除
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "Removing milestone"
          gh pr edit "$PR_NUMBER" --repo "$REPO" --milestone "" || true
          echo "✓ Milestone removed"
      
      - name: プロジェクトから削除
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "Fetching project items"
          PROJECT_ITEMS=$(gh api graphql -f query='query($owner:String!,$repo:String!,$number:Int!){repository(owner:$owner,name:$repo){pullRequest(number:$number){projectItems(first:10){nodes{id}}}}}' \
            -f owner="${REPO%/*}" -f repo="${REPO#*/}" -F number="$PR_NUMBER" | jq -r '.data.repository.pullRequest.projectItems.nodes[].id')
          
          if [ -n "$PROJECT_ITEMS" ]; then
            echo "Found project items to remove:"
            echo "$PROJECT_ITEMS"
            echo "$PROJECT_ITEMS" | while read -r ITEM_ID; do
              if [ -n "$ITEM_ID" ]; then
                echo "Removing item: $ITEM_ID"
                gh api graphql -f query='mutation($itemId:ID!){deleteProjectV2Item(input:{itemId:$itemId}){deletedItemId}}' -f itemId="$ITEM_ID" || true
              fi
            done
            echo "✓ Project items removed"
          else
            echo "No project items to remove"
          fi
