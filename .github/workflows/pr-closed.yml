name: クローズ後の処理

on:
  pull_request:
    types: [closed]

concurrency:
  group: pr-closed-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  cleanup-on-pr-close:
    name: クローズ時のクリーンアップ
    if: github.event.pull_request.merged == false
    runs-on: ubuntu-slim
    permissions:
      contents: read
      pull-requests: write
      issues: write
      
    steps:
      - name: ラベルの削除
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          # すべてのラベルを取得して削除
          LABELS=$(gh pr view "$PR_NUMBER" --repo "$REPO" --json labels 2>/dev/null | jq -r '.labels[].name' | tr '\n' ',' | sed 's/,$//')
          if [ -n "$LABELS" ]; then
            echo "ラベル削除中: $LABELS"
            gh pr edit "$PR_NUMBER" --repo "$REPO" --remove-label "$LABELS" 2>/dev/null
            echo "✓ ラベルを削除しました"
          else
            echo "削除するラベルはありません"
          fi
      
      - name: マイルストーンの削除
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "マイルストーン削除中"
          gh pr edit "$PR_NUMBER" --repo "$REPO" --milestone "" 2>/dev/null || true
          echo "✓ マイルストーンを削除しました"
      
      - name: プロジェクトから削除
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          echo "プロジェクトアイテム取得中"
          PROJECT_ITEMS=$(gh api graphql -f query='query($owner:String!,$repo:String!,$number:Int!){repository(owner:$owner,name:$repo){pullRequest(number:$number){projectItems(first:10){nodes{id}}}}}' \
            -f owner="${REPO%/*}" -f repo="${REPO#*/}" -F number="$PR_NUMBER" 2>/dev/null | jq -r '.data.repository.pullRequest.projectItems.nodes[].id')
          
          if [ -n "$PROJECT_ITEMS" ]; then
            echo "削除するプロジェクトアイテムを見つけました:"
            echo "$PROJECT_ITEMS"
            echo "$PROJECT_ITEMS" | while read -r ITEM_ID; do
              if [ -n "$ITEM_ID" ]; then
                echo "アイテム削除中: $ITEM_ID"
                gh api graphql -f query='mutation($itemId:ID!){deleteProjectV2Item(input:{itemId:$itemId}){deletedItemId}}' -f itemId="$ITEM_ID" > /dev/null 2>&1 || true
              fi
            done
            echo "✓ プロジェクトアイテムを削除しました"
          else
            echo "削除するプロジェクトアイテムはありません"
          fi
