name: Add Milestone on リリース前 Label

on:
  pull_request:
    branches:
      - main
    types: [opened, reopened, ready_for_review, converted_to_draft]

jobs:
  add-milestone:
    if: startsWith(github.event.pull_request.head.ref, 'develop/')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      
    steps:
      - name: Set milestone based on draft state
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          IS_DRAFT: ${{ github.event.pull_request.draft }}
        run: |
          if [ "$IS_DRAFT" = "true" ]; then
            MILESTONE_NUMBER=2
            echo "Setting milestone 2 (Draft)"
          else
            MILESTONE_NUMBER=3
            echo "Setting milestone 3 (Open)"
          fi
          
          if gh api repos/$REPO/issues/$PR_NUMBER -X PATCH -f milestone=$MILESTONE_NUMBER > /dev/null 2>&1; then
            echo "✓ Milestone $MILESTONE_NUMBER added to PR #$PR_NUMBER"
          else
            echo "✗ Failed to add milestone to PR #$PR_NUMBER"
            exit 1
          fi
