# develop/* -> release/staging のPR管理
# このワークフローは develop/* ブランチから release/staging ブランチへのPRに対してのみ実行されます
# - Ready for review時に「Stagingリリース」ラベルを付与
# - Draft時に「Stagingリリース」ラベルを削除

name: PR / develop → release/staging

on:
  pull_request:
    types: [opened, reopened, ready_for_review, converted_to_draft, synchronize]
    branches:
      - release/staging

env:
  # ラベル定義
  LABEL_STAGING_RELEASE: Stagingリリース

concurrency:
  group: pr-develop-to-staging-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  staging-release-label-management:
    name: Stagingリリースラベルの管理
    if: startsWith(github.event.pull_request.head.ref, 'develop/')
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
    
    steps:
      - name: Ready for review時に「Stagingリリース」ラベルを付与
        if: github.event.pull_request.draft == false
        run: |
          gh pr edit "$NUMBER" --add-label "${{ env.LABEL_STAGING_RELEASE }}" 2>/dev/null
          echo "'${{ env.LABEL_STAGING_RELEASE }}'ラベルを追加しました"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}
      
      - name: Draft時に「Stagingリリース」ラベルを削除
        if: github.event.pull_request.draft == true
        run: |
          gh pr edit "$NUMBER" --remove-label "${{ env.LABEL_STAGING_RELEASE }}" 2>/dev/null || true
          echo "'${{ env.LABEL_STAGING_RELEASE }}'ラベルを削除しました"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}

  staging-confirmation-label-prompt:
    name: Staging確認中ラベルの付与を促す
    if: github.event.pull_request.base.ref == 'release/staging' && startsWith(github.event.pull_request.head.ref, 'develop/') && github.event.action == 'opened'
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
    
    steps:
      - name: Staging確認中ラベルの付与を促すコメントを追加
        run: |
          gh pr comment "$NUMBER" --body "$BODY" 2>/dev/null
          echo "'Staging確認中'ラベル追加を促すコメントを投稿しました"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}
          BODY: 本PRマージ後、developブランチに**Staging確認中**ラベルを付与してください。
