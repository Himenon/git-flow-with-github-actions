# develop/* -> release/staging のPull Request管理
# このワークフローは develop/* ブランチから release/staging ブランチへのPRに対してのみ実行されます
# - Ready for review時に「Stagingリリース」ラベルを付与
# - Draft時に「Stagingリリース」ラベルを削除

name: PR / develop → release/staging

on:
  pull_request:
    types: [opened, reopened, ready_for_review, converted_to_draft, synchronize]
    branches:
      - release/staging

concurrency:
  group: pr-develop-to-staging-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  manage-staging-release-label:
    name: Stagingリリースラベルの管理
    if: startsWith(github.event.pull_request.head.ref, 'develop/')
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
    
    steps:
      - name: Ready for review時に「Stagingリリース」ラベルを付与
        if: github.event.pull_request.draft == false
        run: |
          gh pr edit "$NUMBER" --add-label "Stagingリリース"
          echo "Added 'Stagingリリース' label"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}
      
      - name: Draft時に「Stagingリリース」ラベルを削除
        if: github.event.pull_request.draft == true
        run: |
          gh pr edit "$NUMBER" --remove-label "Stagingリリース" || true
          echo "Removed 'Stagingリリース' label"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}

  prompt-staging-confirmation-label:
    name: Staging確認中ラベルの付与を促す
    if: github.event.pull_request.base.ref == 'release/staging' && startsWith(github.event.pull_request.head.ref, 'develop/') && github.event.action == 'opened'
    runs-on: ubuntu-slim
    permissions:
      pull-requests: write
    
    steps:
      - name: Staging確認中ラベルの付与を促すコメントを追加
        run: |
          gh pr comment "$NUMBER" --body "$BODY"
          echo "Posted comment to prompt adding 'Staging確認中' label"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          NUMBER: ${{ github.event.pull_request.number }}
          BODY: 本PRマージ後、developブランチに**Staging確認中**ラベルを付与してください。
